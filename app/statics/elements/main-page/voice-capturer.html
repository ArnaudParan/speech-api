<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<dom-module id="voice-capturer">

  <template>

    <style>
      div#background-container {
        height: 110px;
        width:110px;
      }
      div#button-background {
        margin: 15px;
      }
      div#button-background > span {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
      }
      paper-button#round-button {
        height: 80px;
        min-width: 0px;
        width: 80px;
        margin: 0px;
        border-radius: 40px;
        background-color: var(--paper-grey-200);
      }
      paper-button#round-button[active] {
        background-color: var(--paper-red-100);
      }
      paper-button#round-button > iron-icon {
        --iron-icon-height: 40px;
        --iron-icon-width: 40px;
      }
    </style>

    <div id="background-container">
      <div id="button-background">
        <span>
          <paper-button id="round-button" active="{{buttonActive}}" on-click="toggleRegistering" raised toggles>
            <iron-icon icon="av:mic"></iron-icon>
          </paper-button>
        </span>
      </div>
    </div>

    <audio controls=""></audio>

  </template>

  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
  <script src="../../bower_components/msr/MediaStreamRecorder.js"></script>
  <script>

    Polymer({

      is: 'voice-capturer',

      ready: function() {
        this.chunks = [];
        navigator.getUserMedia = (navigator.getUserMedia ||
                                  navigator.mozGetUserMedia ||
                                  navigator.msGetUserMedia ||
                                  navigator.webkitGetUserMedia);

        if (navigator.getUserMedia) {
          var constraints = { audio: true };

          var onSuccess = function(stream) {
            this.mediaRecorder = new MediaStreamRecorder(stream);
            this.mediaRecorder.mimeType = 'audio/pcm';

            this.mediaRecorder.ondataavailable = function(e) {
              var reader = new window.FileReader();
              reader.readAsDataURL(e);
              reader.onloadend = function() {
                var base64Sound = reader.result.replace(/^data:audio\/pcm;base64,/, "");
                this.fire('recorded', {sound: base64Sound});
              }.bind(this)
            }.bind(this);
          }.bind(this);

          var onError = function(err) {
            console.log('The following error occured: ' + err);
          };

          navigator.getUserMedia(constraints, onSuccess, onError);
        }
        else  {
          console.log('userMedia not accessible');
        }
      },

      toggleRegistering: function() {
        if (this.buttonActive) {
          this.startRegistering();
        }
        else {
          this.stopRegistering();
        }
      },

      startRegistering: function() {
        this.mediaRecorder.start()
      },

      stopRegistering: function() {
        this.mediaRecorder.stop()
      },

    });

  </script>

</dom-module>
